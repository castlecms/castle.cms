<div tal:define="dutils context/@@dashboard-utils;
                 totals dutils/get_totals|nothing;
                 memberinfo context/portal_membership/getMemberInfo;
                 member context/@@plone_portal_state/member;
                 userId python: member.getId() or member.getId();
                 name python:memberinfo['fullname'] or userId;
                 pm context/portal_membership;
                 member context/plone_portal_state/member;
                 portrait python:pm.getPersonalPortrait(member.getId());
                 user_url portrait/absolute_url;
                 dummy python: utils.add_resource_on_request('castle-dashboard-welcome');"
     class="castle-dashboard-welcome">

 <span tal:replace="structure context/@@authenticator/authenticator"/>

 <h1 class="documentFirstHeading" i18n:translate="heading_dashboard">
   Welcome ${name}
 </h1>
 <div class="user-picture" tal:condition="python: 'defaultUser' not in user_url">
   <img src="${user_url}" />
 </div>
  <p class="welcome-message">
    What do you need to do today?<br/>
  </p>

  <div class="content-totals" tal:condition="totals" style="display: none">
    <!-- ignore for now... -->
    <span class="content-totals-label">Content Totals</span>
    <tal:total tal:repeat="total totals">
      <span class="total-group">
        <span tal:attributes="class string:type contenttype-${python: total['key'].lower()}">${total/key}:</span><span class="count">${total/doc_count}</span>
      </span>
    </tal:total>
  </div>


  <div class="open-sessions" tal:condition="python: dutils.sessions">
    <p class="discreet">You have open sessions</p>
    <table class="table">
      <thead>
        <tr>
          <th>Last activity</th>
          <th>IP</th>
          <th>User Agent</th>
          <th>End</th>
        </tr>
      </thead>
      <tbody>
        <tal:sess tal:repeat="session python: dutils.sessions">
          <tr tal:condition="session/id|nothing">
            <td class="pat-moment"
                   data-pat-moment="format:relative"
                   data-date="${session/updated}Z">${session/updated}</td>
            <td>
              ${python: dutils.whois(session['ip'])}
              (${session/ip})
            </td>
            <td>${python: dutils.parse_ua(session)}</td>
            <td>
              <form method="POST" tal:condition="not: session/expired|nothing">
                <input type="hidden" name="removesession" value="yes" />
                <input type="hidden" name="id" value="${session/id}" />
                <button type="submit" class="plone-btn plone-btn-danger">End Session</button>
              </form>
              <span method="POST" tal:condition="session/expired|nothing">
                Already ended
              </span>
            </td>
          </tr>
        </tal:sess>
      </tbody>
    </table>
  </div>

</div>
